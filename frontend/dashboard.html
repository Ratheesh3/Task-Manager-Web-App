<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-tasks me-2"></i>TaskManager
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="welcomeMessage">Welcome!</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-tachometer-alt me-2"></i>Task Dashboard</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                <i class="fas fa-plus me-1"></i>Add New Task
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-tasks fa-2x mb-2"></i>
                        <h3 id="totalTasks">0</h3>
                        <p>Total Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <h3 id="completedTasks">0</h3>
                        <p>Completed</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h3 id="pendingTasks">0</h3>
                        <p>Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-percentage fa-2x mb-2"></i>
                        <h3 id="completionRate">0%</h3>
                        <p>Completion Rate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>My Tasks
                    <span class="badge bg-primary ms-2" id="tasksCount">0</span>
                </h5>
            </div>
            <div class="card-body">
                <!-- Loading Spinner -->
                <div id="loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading tasks...</p>
                </div>

                <!-- Tasks Container -->
                <div id="tasksContainer">
                    <div class="text-center text-muted py-4" id="emptyState">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <h4>No tasks yet</h4>
                        <p>Get started by creating your first task!</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                            <i class="fas fa-plus me-1"></i>Create Your First Task
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm">
                        <div class="mb-3">
                            <label for="taskTitle" class="form-label">Task Title *</label>
                            <input type="text" class="form-control" id="taskTitle"
                                   placeholder="Enter task title" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="taskDescription"
                                      placeholder="Enter task description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="dueDate" class="form-label">Due Date (Optional)</label>
                            <input type="datetime-local" class="form-control" id="dueDate">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createTask()">
                        <i class="fas fa-save me-1"></i>Save Task
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentUser = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            loadUserData();
            loadTasks();
        });

        // Load user data
        async function loadUserData() {
            // In a real app, you'd have a /me endpoint to get user data
            const token = localStorage.getItem('token');
            if (token) {
                // For demo purposes, we'll just show a generic welcome
                document.getElementById('welcomeMessage').textContent = 'Welcome!';
            }
        }

        // Load tasks from API
        async function loadTasks() {
            showLoading(true);
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_BASE}/tasks/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const tasks = await response.json();
                    displayTasks(tasks);
                    updateStats(tasks);
                } else if (response.status === 401) {
                    // Token expired or invalid
                    logout();
                }
            } catch (error) {
                console.error('Failed to load tasks:', error);
                alert('Failed to load tasks. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Display tasks in the UI
        function displayTasks(tasks) {
            const container = document.getElementById('tasksContainer');
            const emptyState = document.getElementById('emptyState');

            if (tasks.length === 0) {
                container.innerHTML = '';
                container.appendChild(emptyState);
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = '';

            // Sort tasks: pending first, then completed
            const sortedTasks = tasks.sort((a, b) => {
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                return new Date(b.created_at) - new Date(a.created_at);
            });

            sortedTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                container.appendChild(taskElement);
            });
        }

        // Create individual task element
        function createTaskElement(task) {
            const taskDiv = document.createElement('div');
            taskDiv.className = `card task-card mb-3 ${task.completed ? 'completed' : ''}`;
            taskDiv.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="card-title ${task.completed ? 'completed-task' : ''}">
                                ${task.title}
                                ${task.completed ?
                                    '<span class="badge bg-success ms-2"><i class="fas fa-check"></i> Completed</span>' :
                                    '<span class="badge bg-warning ms-2"><i class="fas fa-clock"></i> Pending</span>'
                                }
                            </h5>
                            <p class="card-text ${task.completed ? 'completed-task' : ''}">
                                ${task.description || '<em class="text-muted">No description</em>'}
                            </p>
                            <div class="task-meta">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    Created: ${new Date(task.created_at).toLocaleDateString()}
                                </small>
                                ${task.due_date ? `
                                    <small class="text-muted ms-3">
                                        <i class="fas fa-clock me-1"></i>
                                        Due: ${new Date(task.due_date).toLocaleDateString()}
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                        <div class="btn-group ms-3">
                            ${!task.completed ? `
                                <button class="btn btn-success btn-sm" onclick="completeTask(${task.id})"
                                        title="Mark as complete">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})"
                                    title="Delete task">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return taskDiv;
        }

        // Update statistics
        function updateStats(tasks) {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.completed).length;
            const pendingTasks = totalTasks - completedTasks;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('pendingTasks').textContent = pendingTasks;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('tasksCount').textContent = totalTasks;
        }

        // Create new task
        async function createTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const dueDate = document.getElementById('dueDate').value;

            if (!title.trim()) {
                alert('Task title is required!');
                return;
            }

            const token = localStorage.getItem('token');
            const taskData = { title: title.trim(), description: description.trim() };

            if (dueDate) {
                taskData.due_date = dueDate;
            }

            try {
                const response = await fetch(`${API_BASE}/tasks/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    // Close modal and reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
                    modal.hide();
                    document.getElementById('addTaskForm').reset();

                    // Reload tasks
                    await loadTasks();
                } else {
                    alert('Failed to create task. Please try again.');
                }
            } catch (error) {
                alert('Failed to create task: ' + error.message);
            }
        }

        // Complete task
        async function completeTask(taskId) {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}/complete`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    await loadTasks();
                }
            } catch (error) {
                console.error('Failed to complete task:', error);
                alert('Failed to complete task. Please try again.');
            }
        }

        // Delete task
        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
                return;
            }

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    await loadTasks();
                }
            } catch (error) {
                console.error('Failed to delete task:', error);
                alert('Failed to delete task. Please try again.');
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            }
        }

        // Show/hide loading spinner
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Add event listener for modal show to clear form
        document.getElementById('addTaskModal').addEventListener('show.bs.modal', function () {
            document.getElementById('addTaskForm').reset();
        });
    </script>
</body>
</html>